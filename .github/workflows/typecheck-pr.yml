name: PR Typecheck (new errors only)

on:
  pull_request:

jobs:
  pyright-diff:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pyright
        run: pip install pyright

      - name: Run pyright on base
        run: |
          git fetch --no-tags --depth=1 origin "${{ github.event.pull_request.base.sha }}"
          git worktree add /tmp/base "${{ github.event.pull_request.base.sha }}"
          cd /tmp/base
          pyright --outputjson > /tmp/base-pyright.json || true

      - name: Run pyright on head
        run: |
          pyright --outputjson > /tmp/head-pyright.json || true

      - name: Report only newly introduced errors
        run: |
          python - <<'PY'
          import json
          import os
          from collections import Counter
          from pathlib import Path

          def normalize_file(path_value, root):
              p = path_value.replace("\\", "/")
              r = root.replace("\\", "/").rstrip("/")
              if r and p.startswith(r + "/"):
                  return p[len(r) + 1 :]
              return p

          def read_errors(path, root):
              data = json.loads(Path(path).read_text(encoding="utf-8"))
              out = []
              for d in data.get("generalDiagnostics", []):
                  if d.get("severity") != "error":
                      continue
                  start = d.get("range", {}).get("start", {})
                  out.append(
                      {
                          "file": normalize_file(d.get("file", ""), root),
                          "rule": d.get("rule", ""),
                          "message": d.get("message", ""),
                          "line": int(start.get("line", 0)) + 1,
                          "col": int(start.get("character", 0)) + 1,
                      }
                  )
              return out

          base = read_errors("/tmp/base-pyright.json", "/tmp/base")
          head = read_errors("/tmp/head-pyright.json", os.environ.get("GITHUB_WORKSPACE", ""))
          base_counts = Counter((e["file"], e["rule"], e["message"]) for e in base)
          seen = Counter()
          new_errors = []

          for e in head:
              key = (e["file"], e["rule"], e["message"])
              seen[key] += 1
              if seen[key] > base_counts[key]:
                  new_errors.append(e)

          if not new_errors:
              print("No newly introduced type errors.")
          else:
              print(f"Newly introduced type errors: {len(new_errors)}")
              for e in new_errors:
                  msg = e["message"].replace("\n", " ").strip()
                  print(f"::warning file={e['file']},line={e['line']},col={e['col']}::{msg}")
          PY